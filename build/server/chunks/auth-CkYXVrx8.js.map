{"version":3,"file":"auth-CkYXVrx8.js","sources":["../../../.svelte-kit/adapter-node/chunks/auth.js"],"sourcesContent":["import { r as redirect } from \"./index2.js\";\nimport { d as db } from \"./database.js\";\nimport bcrypt from \"bcryptjs\";\ndb.exec(`\n  CREATE TABLE IF NOT EXISTS sessions (\n    id TEXT PRIMARY KEY,\n    user_id INTEGER NOT NULL,\n    role TEXT NOT NULL,\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE\n  )\n`);\nasync function login(username, password) {\n  try {\n    const user = db.prepare(\"SELECT * FROM users WHERE username = ?\").get(username);\n    if (!user) {\n      return { success: false, message: \"Invalid username or password\" };\n    }\n    const validPassword = await bcrypt.compare(password, user.password_hash);\n    if (!validPassword) {\n      return { success: false, message: \"Invalid username or password\" };\n    }\n    const sessionId = crypto.randomUUID();\n    db.prepare(\n      `\n      INSERT INTO sessions (id, user_id, role)\n      VALUES (?, ?, ?)\n    `\n    ).run(sessionId, user.id, user.role);\n    return {\n      success: true,\n      sessionId,\n      user: {\n        id: user.id,\n        display_name: user.display_name,\n        username: user.username,\n        role: user.role\n      }\n    };\n  } catch (error) {\n    console.error(\"Login error:\", error);\n    return { success: false, message: \"An error occurred during login\" };\n  }\n}\nfunction getSession(sessionId) {\n  try {\n    const sessionRow = db.prepare(\n      `\n            SELECT\n                s.id,\n                s.user_id AS userId,  -- <<< IMPORTANT: Alias 'user_id' to 'userId'\n                s.created_at AS createdAt,\n                u.role                -- Join with users table to get role if needed\n            FROM sessions s\n            JOIN users u ON s.user_id = u.id\n            WHERE s.id = ?\n        `\n    ).get(sessionId);\n    if (sessionRow) {\n      return {\n        id: sessionRow.id,\n        userId: sessionRow.userId,\n        // Use the aliased name here\n        role: sessionRow.role,\n        createdAt: new Date(sessionRow.createdAt)\n      };\n    }\n    return void 0;\n  } catch (error) {\n    console.error(\"Error in getSession:\", error);\n    return void 0;\n  }\n}\nfunction logout(sessionId) {\n  try {\n    db.prepare(\"DELETE FROM sessions WHERE id = ?\").run(sessionId);\n  } catch (error) {\n    console.error(\"Logout error:\", error);\n  }\n}\nasync function requireAuth(event) {\n  const sessionId = event.cookies.get(\"sessionId\");\n  const session = sessionId ? getSession(sessionId) : null;\n  if (!session) {\n    throw redirect(303, \"/login\");\n  }\n  return session;\n}\nasync function requireRole(event, roles) {\n  const session = await requireAuth(event);\n  if (!roles.includes(session.role)) {\n    throw redirect(303, \"/unauthorized\");\n  }\n  return session;\n}\nfunction getUserById(userId) {\n  try {\n    const user = db.prepare(\n      \"SELECT id, username, display_name, password_hash, role, profile_image FROM users WHERE id = ?\"\n    ).get(userId);\n    if (user) {\n      const profile_image_url = user.profile_image ? `/api/uploads/${user.profile_image.replace(/\\\\/g, \"/\")}` : null;\n      return {\n        ...user,\n        profile_image_url\n        // Add the new URL property\n      };\n    }\n    return void 0;\n  } catch (error) {\n    console.error(\"Error getting user by ID:\", error);\n    return void 0;\n  }\n}\nexport {\n  getUserById as a,\n  logout as b,\n  getSession as g,\n  login as l,\n  requireRole as r\n};\n"],"names":[],"mappings":"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"}