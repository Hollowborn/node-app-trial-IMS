{"version":3,"file":"hooks.server-CK-551md.js","sources":["../../../.svelte-kit/adapter-node/chunks/hooks.server.js"],"sourcesContent":["import { r as redirect } from \"./index2.js\";\nimport { g as getSession, b as getUserById, a as logout } from \"./auth.js\";\nimport cron from \"node-cron\";\nimport { d as db } from \"./database.js\";\nlet cronJobInitialized = false;\nconst handle = async ({ event, resolve }) => {\n  const sessionId = event.cookies.get(\"sessionId\");\n  let user = null;\n  console.log(\"--- hooks.server.ts START ---\");\n  console.log(\"Request URL:\", event.url.pathname);\n  console.log(\"Session ID from cookie:\", sessionId);\n  if (!cronJobInitialized) {\n    console.log(\"Initializing monthly session cleanup cron job...\");\n    cron.schedule(\"0 0 1 * *\", () => {\n      console.log(\"Running monthly session cleanup...\");\n      try {\n        db.prepare(\n          \"DELETE FROM sessions WHERE created_at < strftime('%Y-%m-%d %H:%M:%S', 'now', '-1 month');\"\n        ).run();\n        console.log(\"Monthly session cleanup completed.\");\n      } catch (error) {\n        console.error(\"Error during monthly session cleanup:\", error);\n      }\n    });\n    cronJobInitialized = true;\n  }\n  if (sessionId) {\n    const session = getSession(sessionId);\n    console.log(\"Session retrieved by getSession:\", session);\n    if (session) {\n      const fetchedUser = getUserById(session.userId);\n      console.log(\"User fetched by getUserById:\", fetchedUser);\n      if (fetchedUser) {\n        user = {\n          id: fetchedUser.id,\n          username: fetchedUser.username,\n          display_name: fetchedUser.display_name,\n          role: fetchedUser.role,\n          profile_image: fetchedUser.profile_image\n          // Make sure this is included in your User type in auth.ts\n        };\n        console.log(\"event.locals.user WILL BE:\", user);\n      } else {\n        console.log(\n          \"User NOT FOUND for session ID:\",\n          sessionId,\n          \"Logging out session.\"\n        );\n        logout(sessionId);\n        event.cookies.delete(\"sessionId\", { path: \"/\" });\n      }\n    } else {\n      console.log(\n        \"Session NOT FOUND for session ID:\",\n        sessionId,\n        \"Deleting cookie.\"\n      );\n      event.cookies.delete(\"sessionId\", { path: \"/\" });\n    }\n  } else {\n    console.log(\"No session ID found in cookie.\");\n  }\n  event.locals.user = user;\n  if (event.url.pathname === \"/logout\") {\n    console.log(\"Handling logout request.\");\n    if (sessionId) {\n      logout(sessionId);\n      event.cookies.delete(\"sessionId\", { path: \"/\" });\n    }\n    throw redirect(303, \"/login\");\n  }\n  const response = await resolve(event);\n  console.log(\"--- hooks.server.ts END ---\");\n  return response;\n};\nexport {\n  handle\n};\n"],"names":[],"mappings":"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"}